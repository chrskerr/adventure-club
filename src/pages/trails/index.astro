---
import { getCollection } from 'astro:content'
import 'leaflet/dist/leaflet.css'

import Layout from '@/layouts/base.astro'
import type { TrailData } from './_types'

const allTrails = await getCollection('trails')

const trails = allTrails.map<TrailData>((trail) => ({
  id: trail.id,
  title: trail.data.title,
  startLatLng: trail.data.startLatLng,
}))
---

<script>
  import L from 'leaflet'
  import type { TrailData } from './_types'

  const mapDiv = document.getElementById('map')
  if (mapDiv == null) {
    throw new Error('Map div not found')
  }

  const trailsJson = mapDiv.getAttribute('data-trails')
  if (trailsJson == null) {
    throw new Error('data-trails attribute not set')
  }

  const trails = JSON.parse(trailsJson) as TrailData[]

  const map = L.map('map')

  let minLat = -Infinity
  let maxLat = Infinity
  let minLng = -Infinity
  let maxLng = Infinity

  for (const {
    id,
    title,
    startLatLng: [lat, lng],
  } of trails) {
    minLat = Math.max(minLat, lat)
    maxLat = Math.min(maxLat, lat)
    minLng = Math.max(minLng, lng)
    maxLng = Math.min(maxLng, lng)

    L.marker([lat, lng])
      .addTo(map)
      .bindPopup(`<a href="/trails/${id}">${title}</a>`)
  }

  map
    .setMaxBounds([
      [-45, 144],
      [-40, 150],
    ])
    .setMinZoom(7)
    .fitBounds([
      [maxLat, maxLng],
      [minLat, minLng],
    ])

  L.tileLayer(
    'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',
    {
      attribution:
        '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 20,
    },
  ).addTo(map)
</script>

<Layout meta={{ title: 'All trails' }}>
  <div
    class="rounded-base h-[500px] border-2 border-black"
    id="map"
    data-trails={JSON.stringify(trails)}
  >
  </div>
</Layout>
